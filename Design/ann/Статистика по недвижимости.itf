Статистика по недвижимостиСтатистика по недвижимости&{0921F68E-E564-4172-A84A-5D6237FC32D5}Яunit Main;
{ модуль разработан ФИО }

interface

procedure fmStatbtRunClick(Sender: TObject);
procedure fmStatbtCloseClick(Sender: TObject);
procedure fmStatClose(Sender: TObject; var Action: TCloseAction);
procedure fmStatbtReleaseClick(Sender: TObject);
procedure fmStatrptGetValue(const ParName: String; var ParValue: Variant);

implementation

var
  NumRelease: Integer;

procedure SetRelease;
begin
  fmStat.rbi.Visual.TypeView:=tviOnlyData;
  fmStat.rbi.Condition.WhereStr.Clear;
  fmStat.rbi.Condition.WhereStr.Add(' release_id='+fmStat.edRelease.Tag+' ');
  if fmStat.rbi.View then begin
    if not fmStat.memd.IsEmpty then begin
      NumRelease:=fmStat.memd.FieldByName('numrelease').AsInteger;
      fmStat.edRelease.Text:=Trim(fmStat.memd.FieldByName('about').AsString+
                             ' ('+fmStat.memd.FieldByName('numrelease').AsString+')');
    end;
  end;
end;

procedure ViewInterface;
begin
  if fmStat.FormStyle<>fsMDIChild then begin
    fmStat.edRelease.Tag:=ReadParam(GetInterfaceName,fmStat.edRelease.Name,fmStat.edRelease.Tag);
    SetRelease;
    fmStat.FormStyle:=fsMDIChild;
  end else begin
    fmStat.WindowState:=wsNormal;
    fmStat.BringToFront;
    fmStat.Show;
  end;
end;

procedure ShowReport;
var
  S: String;
begin
  fmStat.siSplash.View;
  Screen.Cursor:=crHourGlass;
  try
    Application.ProcessMessages;

    fmStat.qrStat.Active:=false;
    fmStat.tran.Active:=false;

    fmStat.qrStat.Params.ParamByName('RELEASE_ID').Value:=fmStat.edRelease.Tag;
  
    fmStat.tran.Active:=true;
    fmStat.qrStat.Active:=true;

    fmStat.rpt.ShowReport;
  finally
    Screen.Cursor:=crDefault;
    fmStat.siSplash.Close;
  end;
end;

procedure fmStatbtRunClick(Sender: TObject);
begin
  if Trim(fmStat.edRelease.Text)='' then begin
    ShowInfoEx('Выберите выпуск');
    fmStat.btRelease.SetFocus;
    exit;
  end;
  ShowReport;
end;

procedure fmStatbtCloseClick(Sender: TObject);
begin
  fmStat.Close;
end;

procedure fmStatClose(Sender: TObject; var Action: TCloseAction);
begin
  WriteParam(GetInterfaceName,fmStat.edRelease.Name,fmStat.edRelease.Tag);
  Action:=caFree;
end;

procedure fmStatbtReleaseClick(Sender: TObject);
begin
  fmStat.rbi.Visual.TypeView:=tvibvModal;
  fmStat.rbi.Condition.WhereStr.Clear;
  fmStat.rbi.Locate.KeyFields:='release_id';
  fmStat.rbi.Locate.KeyValues:=fmStat.edRelease.Tag;
  if fmStat.rbi.View then begin
    if not fmStat.memd.IsEmpty then begin
      fmStat.edRelease.Tag:=fmStat.memd.FieldByName('release_id').AsInteger;
      NumRelease:=fmStat.memd.FieldByName('numrelease').AsInteger;
      fmStat.edRelease.Text:=Trim(fmStat.memd.FieldByName('about').AsString+
                             ' ('+fmStat.memd.FieldByName('numrelease').AsString+')');
    end;
  end;
end;

procedure fmStatrptGetValue(const ParName: String; var ParValue: Variant);
begin
  if AnsiSameText(ParName,'Выпуск') then ParValue:=fmStat.edRelease.Text;
end;

end.
в8object fmStat: TfmStat
  Left = 30
  Top = 18
  ActiveControl = btRun
  BorderIcons = [biSystemMenu, biMinimize]
  BorderStyle = bsSingle
  Caption = 'Статистика по недвижимости'
  ClientHeight = 78
  ClientWidth = 292
  Color = clBtnFace
  Constraints.MaxHeight = 105
  Constraints.MaxWidth = 300
  Font.Charset = DEFAULT_CHARSET
  Font.Color = clWindowText
  Font.Height = -1
  Font.Name = 'MS Sans Serif'
  Font.Style = []
  Icon.Data = {
    0000010001001010100000000000280100001600000028000000100000002000
    00000100040000000000C0000000000000000000000000000000000000000000
    000000008000008000000080800080000000800080008080000080808000C0C0
    C0000000FF0000FF000000FFFF00FF000000FF00FF00FFFF0000FFFFFF000000
    0000000000000000000000000000078888888888880007FFFFFFFFFFF80007FF
    00FF00FFF80007FF00F00FFFF80007FF0000FFFFF80007FF000FFFFFF80007FF
    0000FFFFF80007FF00FF0FFFF80007FF00FF0FFFF80007FF00FF0FF0000007FF
    0000FFF7880007FFFFFFFFF7800007FFFFFFFFF700000777777777770000FFFF
    0000800100008001000080010000800100008001000080010000800100008001
    0000800100008001000080010000800100008003000080070000800F0000}
  OldCreateOrder = False
  Position = poScreenCenter
  OnClose = fmStatClose
  EnabledAdjust = False
  PixelsPerInch = 96
  TextHeight = 13
  object lbRelease: TiLabel
    Left = 22
    Top = 16
    Width = 41
    Height = 13
    Alignment = taRightJustify
    Caption = 'Выпуск:'
  end
  object edRelease: TiEdit
    Left = 73
    Top = 13
    Width = 177
    Height = 21
    Color = clBtnFace
    ReadOnly = True
    TabOrder = 0
  end
  object btRelease: TiButton
    Left = 256
    Top = 13
    Width = 21
    Height = 21
    Caption = '...'
    TabOrder = 1
    OnClick = fmStatbtReleaseClick
  end
  object btRun: TiButton
    Left = 94
    Top = 47
    Width = 107
    Height = 25
    Hint = 'Сформировать отчет'
    Anchors = [akRight, akBottom]
    Caption = 'Сформировать'
    Default = True
    TabOrder = 2
    OnClick = fmStatbtRunClick
  end
  object btClose: TiButton
    Left = 210
    Top = 47
    Width = 75
    Height = 25
    Hint = 'Закрыть'
    Anchors = [akRight, akBottom]
    Caption = 'Закрыть'
    TabOrder = 3
    OnClick = fmStatbtCloseClick
  end
  object rbi: TiRBookInterface
    Visual.TypeView = tvibvModal
    Visual.MultiSelect = False
    ReturnData = memd
    Locate.Options = []
    ExecProcedure.Params = <>
    InterfaceName = 'Справочник выпусков'
    Left = 41
    Top = 8
  end
  object memd: TitsvMemoryData
    FieldDefs = <>
    Left = 73
    Top = 8
  end
  object tran: TiIBTransaction
    Active = False
    DefaultDatabase = MainDataBase.Owner
    Params.Strings = (
      'read_committed'
      'rec_version'
      'nowait')
    AutoStopAction = saNone
    Left = 136
    Top = 8
  end
  object qrStat: TiIBQuery
    Database = MainDataBase.Owner
    Transaction = tran
    BufferChunks = 1000
    CachedUpdates = False
    SQL.Strings = (
      'SELECT'
      'A.FULLNAME,'
      
        '(SELECT COUNT(*) FROM AP_PREMISES P1 WHERE P1.AP_OPERATION_ID=14' +
        ' AND P1.AP_AGENCY_ID=A.AP_AGENCY_ID AND P1.RELEASE_ID=:RELEASE_I' +
        'D) AS F1,'
      
        '(SELECT COUNT(*) FROM AP_PREMISES P1 WHERE P1.AP_OPERATION_ID=15' +
        ' AND P1.AP_AGENCY_ID=A.AP_AGENCY_ID AND P1.RELEASE_ID=:RELEASE_I' +
        'D) AS F2,'
      
        '(SELECT COUNT(*) FROM AP_PREMISES P1 WHERE P1.AP_OPERATION_ID=17' +
        ' AND P1.AP_AGENCY_ID=A.AP_AGENCY_ID AND P1.RELEASE_ID=:RELEASE_I' +
        'D) AS F3,'
      
        '(SELECT COUNT(*) FROM AP_PREMISES P1 WHERE P1.AP_OPERATION_ID=20' +
        ' AND P1.AP_AGENCY_ID=A.AP_AGENCY_ID AND P1.RELEASE_ID=:RELEASE_I' +
        'D) AS F4'
      'FROM AP_AGENCY A'
      'GROUP BY A.FULLNAME'
      'ORDER BY A.FULLNAME')
    Left = 104
    Top = 8
    ParamData = <
      item
        DataType = ftUnknown
        Name = 'RELEASE_ID'
        ParamType = ptUnknown
      end
      item
        DataType = ftUnknown
        Name = 'RELEASE_ID'
        ParamType = ptUnknown
      end
      item
        DataType = ftUnknown
        Name = 'RELEASE_ID'
        ParamType = ptUnknown
      end
      item
        DataType = ftUnknown
        Name = 'RELEASE_ID'
        ParamType = ptUnknown
      end>
  end
  object siSplash: TiServiceInterface
    ExecProcedure.Params = <>
    InterfaceName = 'Заставка'
    Left = 8
    Top = 8
  end
  object dsRpt: TifrDBDataset
    DataSet = qrStat
    Left = 8
    Top = 40
  end
  object rpt: TifrReport
    InitialZoom = pzDefault
    MDIPreview = True
    ModalPreview = False
    ModifyPrepared = False
    PreviewButtons = [pbZoom, pbLoad, pbSave, pbPrint, pbFind, pbExit, pbPageSetup]
    ShowProgress = False
    StoreInDFM = True
    OnGetValue = fmStatrptGetValue
    Left = 41
    Top = 40
    ReportForm = {
      1800000063100000180000000001000100FFFFFFFFFF090000009A0B00003408
      00002400000024000000240000002400000001FFFF0000FFFFFFFF0000000000
      00000000000000030400466F726D000F000080DC000000780000007C0100002C
      010000040000000200CB0000000C005265706F72745469746C65310002010000
      0000200000002F040000220000003000000001000000000000000000FFFFFF1F
      00000000000000000000000000FFFF0000000000020000000100000000000000
      01000000C80000001400000001000000000000020030010000050042616E6431
      000201000000005C0000002F0400001200000030000200010000000000000000
      00FFFFFF1F00000000000000000000000000FFFF000000000002000000010000
      000000000001000000C8000000140000000100000000000002009A0100000500
      42616E643200020100000000840000002F040000120000003000050001000000
      000000000000FFFFFF1F000000000500647352707400000000000000FFFF0000
      00000002000000010000000000000001000000C8000000140000000100000000
      00000200080200000E005265706F727453756D6D6172793100020100000000B4
      0000002F040000120000003000010001000000000000000000FFFFFF1F000000
      00000000000000000000FFFF0000000000020000000100000000000000010000
      00C800000014000000010000000000000200730200000B0050616765466F6F74
      65723100020100000000E80000002F0400000D00000030000300010000000000
      00000000FFFFFF1F00000000000000000000000000FFFF000000000002000000
      010000000000000001000000C800000014000000010000000000000000110300
      0005004D656D6F31000200F4000000240000002C010000120000000300000001
      000000000000000000FFFFFF1F2C02000000000001002000D1F2E0F2E8F1F2E8
      EAE020EFEE20E8ECEFEEF0F2F320E7E020E2FBEFF3F1EA3A00000000FFFF0000
      0000000200000001000000000500417269616C000C0000000000000000000100
      0000CC00020000000000FFFFFF00000000020000000000000000009703000005
      004D656D6F320002002402000024000000700100001200000003000000010000
      00000000000000FFFFFF1F2C020000000000010008005BC2FBEFF3F1EA5D0000
      0000FFFF00000000000200000001000000000500417269616C000C0000000200
      0000000000000000CC00020000000000FFFFFF00000000020000000000000000
      002204000005004D656D6F3500020024000000240000007C0000001200000003
      00000001000000000000000000FFFFFF1F2C02000000000001000D005B54494D
      455D205B444154455D00000000FFFF0000000000020000000100000000050041
      7269616C000600000000000000000000000000CC00020000000000FFFFFF0000
      000002000000000000000000A904000005004D656D6F33000200510000005C00
      00005F0100001200000003000F0001000000000000000000FFFFFF1F2C020000
      00000001000900C0E3E5EDF2F1F2E2EE00000000FFFF00000000000200000001
      000000000500417269616C000A00000002000000000002000000CC0002000000
      0000FFFFFF00000000020000000000000000003A05000005004D656D6F340002
      0051000000840000005F0100001200000007000F0001000000000000000000FF
      FFFF1F2C020000000000010013005B7172537461742E2246554C4C4E414D4522
      5D00000000FFFF00000000000200000001000000000500417269616C00080000
      0000000000000000000000CC00020000000000FFFFFF00000000020000000000
      00000000C605000005004D656D6F36000200B00100005C000000790000001200
      000003000F0001000000000000000000FFFFFF1F2C02000000000001000E00C3
      EEF2EEE2EEE520EFF0EEE4E0EC00000000FFFF00000000000200000001000000
      000500417269616C000A00000002000000000002000000CC00020000000000FF
      FFFF00000000020000000000000000005106000005004D656D6F37000200B001
      000084000000790000001200000003000F0001000000000000000000FFFFFF1F
      2C02000000000001000D005B7172537461742E224631225D00000000FFFF0000
      0000000200000001000000000500417269616C00080000000000000000000100
      0000CC00020000000000FFFFFF0000000002000000000000000000D906000005
      004D656D6F38000200940300005C000000750000001200000003000F00010000
      00000000000000FFFFFF1F2C02000000000001000A00CAEEEBE8F7E5F1F2E2EE
      00000000FFFF00000000000200000001000000000500417269616C000A000000
      02000000000002000000CC00020000000000FFFFFF0000000002000000000000
      0000009007000005004D656D6F39000200940300008400000075000000120000
      0007000F0001000000000000000000FFFFFF1F2C020000000000010039005B5B
      7172537461742E224631225D2B5B7172537461742E224632225D2B5B71725374
      61742E224633225D2B5B7172537461742E224634225D5D00000000FFFF000000
      00000200000001000000000500417269616C0008000000000000000000010000
      00CC00020000000000FFFFFF0000000002000000000000000000140800000600
      4D656D6F313000020038010000B4000000780000001200000003000000010000
      00000000000000FFFFFF1F2C02000000000001000500C2F1E5E3EE00000000FF
      FF00000000000200000001000000000500417269616C000A0000000200000000
      0001000000CC00020000000000FFFFFF0000000002000000000000000000AE08
      000006004D656D6F3131000200B1010000B40000007800000012000000030000
      0001000000000000000000FFFFFF1F2C02000000000001001B005B53554D285B
      7172537461742E224631225D2C2042616E6432295D00000000FFFF0000000000
      0200000001000000000500417269616C000A00000002000000000001000000CC
      00020000000000FFFFFF00000000020000000000000000003A09000006004D65
      6D6F3132000200290200005C000000790000001200000003000F000100000000
      0000000000FFFFFF1F2C02000000000001000D00C3EEF2EEE2EEE520EAF3EFEB
      FE00000000FFFF00000000000200000001000000000500417269616C000A0000
      0002000000000002000000CC00020000000000FFFFFF00000000020000000000
      00000000C409000006004D656D6F3133000200A20200005C0000007900000012
      00000003000F0001000000000000000000FFFFFF1F2C02000000000001000B00
      C0F0E5EDE4E020F1E4E0EC00000000FFFF000000000002000000010000000005
      00417269616C000A00000002000000000002000000CC00020000000000FFFFFF
      00000000020000000000000000004E0A000006004D656D6F31340002001B0300
      005C000000790000001200000003000F0001000000000000000000FFFFFF1F2C
      02000000000001000B00C0F0E5EDE4E020F1E4E0EC00000000FFFF0000000000
      0200000001000000000500417269616C000A00000002000000000002000000CC
      00020000000000FFFFFF0000000002000000000000000000DA0A000006004D65
      6D6F31350002002902000084000000790000001200000003000F000100000000
      0000000000FFFFFF1F2C02000000000001000D005B7172537461742E22463222
      5D00000000FFFF00000000000200000001000000000500417269616C00080000
      0000000000000001000000CC00020000000000FFFFFF00000000020000000000
      00000000660B000006004D656D6F3136000200A2020000840000007900000012
      00000003000F0001000000000000000000FFFFFF1F2C02000000000001000D00
      5B7172537461742E224633225D00000000FFFF00000000000200000001000000
      000500417269616C000800000000000000000001000000CC00020000000000FF
      FFFF0000000002000000000000000000F20B000006004D656D6F31370002001B
      03000084000000790000001200000003000F0001000000000000000000FFFFFF
      1F2C02000000000001000D005B7172537461742E224634225D00000000FFFF00
      000000000200000001000000000500417269616C000800000000000000000001
      000000CC00020000000000FFFFFF00000000020000000000000000008C0C0000
      06004D656D6F31380002002B020000B400000078000000120000000300000001
      000000000000000000FFFFFF1F2C02000000000001001B005B53554D285B7172
      537461742E224632225D2C2042616E6432295D00000000FFFF00000000000200
      000001000000000500417269616C000A00000002000000000001000000CC0002
      0000000000FFFFFF0000000002000000000000000000260D000006004D656D6F
      3139000200A3020000B400000078000000120000000300000001000000000000
      000000FFFFFF1F2C02000000000001001B005B53554D285B7172537461742E22
      4633225D2C2042616E6432295D00000000FFFF00000000000200000001000000
      000500417269616C000A00000002000000000001000000CC00020000000000FF
      FFFF0000000002000000000000000000C00D000006004D656D6F32300002001B
      030000B400000078000000120000000300000001000000000000000000FFFFFF
      1F2C02000000000001001B005B53554D285B7172537461742E224634225D2C20
      42616E6432295D00000000FFFF00000000000200000001000000000500417269
      616C000A00000002000000000001000000CC00020000000000FFFFFF00000000
      02000000000000000000840E000006004D656D6F323100020094030000B40000
      0074000000120000000300000001000000000000000000FFFFFF1F2C02000000
      0000010045005B53554D285B7172537461742E224631225D2B5B717253746174
      2E224632225D2B5B7172537461742E224633225D2B5B7172537461742E224634
      225D2C2042616E6432295D00000000FFFF000000000002000000010000000005
      00417269616C000A00000002000000000001000000CC00020000000000FFFFFF
      0000000002000000000000000000040F000006004D656D6F3232000200240000
      005C0000002D0000001200000003000F0001000000000000000000FFFFFF1F2C
      02000000000001000100B900000000FFFF000000000002000000010000000005
      00417269616C000A00000002000000000002000000CC00020000000000FFFFFF
      00000000020000000000000000008A0F000006004D656D6F3233000200240000
      00840000002D0000001200000003000F0001000000000000000000FFFFFF1F2C
      020000000000010007005B4C494E45235D00000000FFFF000000000002000000
      01000000000500417269616C000800000000000000000001000000CC00020000
      000000FFFFFF00000000020000000000000000001910000006004D656D6F3234
      00020075030000E8000000940000000D00000003000000010000000000000000
      00FFFFFF1F2C02000000000001001000D1F2F0E0EDE8F6E0205B50414745235D
      00000000FFFF00000000000200000001000000000500417269616C0006000000
      00000000000001000000CC00020000000000FFFFFF0000000002000000000000
      00FEFEFF03000000040020C2F1E5000000000600C2FBEFF3F1EA000000000A00
      CAEEEBE8F7E5F1F2E2EE000E007172507265762E22434F554E54220000000000
      00000000FDFF0100000000}
  end
  object ifrHTMExport1: TifrHTMExport
    ScaleX = 1
    ScaleY = 1
    Left = 72
    Top = 40
  end
end
fmStat 